generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Usuario de la app (puede ser cuidador o paciente)

model User {
  id         Int        @id @default(autoincrement())
  name       String
  email      String     @unique
  password   String?
  provider   String     @default("email")
  providerId String?    @unique
  verified   Boolean    @default(false)
  
  role       Role?      // üëà AHORA ES OPCIONAL
  gender     String?
  phone      String?    @default("") // üëà AGREGADO
  bio        String?    @default("")
  photoUrl   String?    @default("")
  
  sharingCode String?    @unique // üëà C√≥digo √∫nico del cuidador para sus pacientes
  fcmToken    String?    // üîî Token para notificaciones push (FCM)
  
  patients   Patient[]  @relation("CaregiverPatients")
  invitations Invitation[] // ‚úÖ L√çNEA AGREGADA
  createdAt  DateTime   @default(now())
  Medicine   Medicine[]
  patientProfile Patient? @relation("UserPatientProfile")
}

  
// Paciente vinculado a un cuidador

model Patient {
  id          Int        @id @default(autoincrement())
  name        String
  email       String?    @unique
  age         Int?
  gender      String?
  condition   String?    @default("")
  emergencyPhone String?
  caregiver   User?      @relation("CaregiverPatients", fields: [caregiverId], references: [id])
  caregiverId Int?
  
  linkCode    String?    @unique
  userId      Int?       @unique
  user        User?      @relation("UserPatientProfile", fields: [userId], references: [id])
  
  robotSerialNumber String? @unique // üëà Vincula este paciente a un robot f√≠sico
  
  medicines   Medicine[]
}

// Medicamento asociado a un paciente

model Medicine {
  id          Int        @id @default(autoincrement())
  name        String
  dosage      String
  stock       Int?       @default(0)
  qrData      Json?
  time        String?         // "08:00"
  days        String[]         // ["Lu","Ma","Mi"]
  label       String?          // "Despu√©s del almuerzo"
  slot        Int?             // üëà Nuevo: N√∫mero de motor/carril (1-6)
  
  // ‚ú® NUEVOS CAMPOS AVANZADOS
  icon        String?          @default("pill") // Nombre del icono (p. ej. "medkit", "water")
  instructions String?         @default("")     // "Tomar con mucha agua"
  category    String?          @default("General") // "AnalgeÃÅsico", "Vitamina", etc.
  stockAlert  Int?             @default(5)      // Avisar cuando queden 5
  imageUrls   String[]         @default([]) // üëà URLs o Base64 de las fotos reales (m√°ximo 3)
  
  patient     Patient?   @relation(fields: [patientId], references: [id])
  patientId   Int?
  caregiver   User?      @relation(fields: [caregiverId], references: [id])
  caregiverId Int?
  
  reminders   Reminder[]
  dispensationLogs DispensationLog[]
  createdAt   DateTime   @default(now())
}
 
model Reminder {
  id         Int      @id @default(autoincrement())
  time       String // "08:00 AM"
  days       String // "Lu,Ma,Mi,Ju,Vi" o "" si es una sola vez
  label      String? // "Despu√©s del almuerzo"
  repeat     Boolean  @default(true)
  active     Boolean  @default(true)
  medicine   Medicine @relation(fields: [medicineId], references: [id])
  medicineId Int
  createdAt  DateTime @default(now())
}

// Estado del robot (bater√≠a, wifi, etc.)

model RobotState {
  id             Int      @id @default(autoincrement())
  serialNumber   String   @default("PB-001") // üëà Permite saber a qu√© robot pertenece este estado
  status         String   // "OK", "DISPENSANDO", "ERROR"
  wifi           Boolean  @default(false)
  batteryPct     Int      @default(0)
  temperature    Float?   @default(0) 
  uptime         String?  @default("") 
  signalStrength Int?     @default(0)  
  updatedAt      DateTime @default(now())
  
  @@index([serialNumber])
}
 
// ‚úÖ MODELO NUEVO AGREGADO
model Invitation {
  id          Int      @id @default(autoincrement())
  token       String   @unique  // Token √∫nico para compartir
  caregiverId Int
  caregiver   User     @relation(fields: [caregiverId], references: [id])
  patientEmail String?  // Email del paciente (opcional)
  patientName  String?  // Nombre del paciente (opcional)
  used        Boolean  @default(false)
  expiresAt   DateTime
  createdAt   DateTime @default(now())
}

model RobotLog {
  id          Int      @id @default(autoincrement())
  medicineId  Int?
  message     String
  createdAt   DateTime @default(now())
}

model DispensationLog {
  id          Int      @id @default(autoincrement())
  medicineId  Int
  medicine    Medicine @relation(fields: [medicineId], references: [id])
  patientId   Int?
  status      String   // "DISPENSED", "TAKEN", "MISSED"
  mood        String?  // üëà Nuevo: "GOOD", "NORMAL", "BAD"
  dispensedAt DateTime @default(now())
}

model PasswordReset {
  id        Int      @id @default(autoincrement())
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

enum Role {
  CUIDADOR
  PACIENTE
}