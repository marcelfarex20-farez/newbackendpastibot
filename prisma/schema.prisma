generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             Int          @id @default(autoincrement())
  name           String
  email          String       @unique
  password       String?
  provider       String       @default("email")
  providerId     String?      @unique
  verified       Boolean      @default(false)
  role           Role?
  gender         String?
  bio            String?      @default("")
  photoUrl       String?      @default("")
  phone          String?      @default("")
  sharingCode    String?      @unique
  createdAt      DateTime     @default(now())
  fcmToken       String?
  invitations    Invitation[]
  Medicine       Medicine[]
  patients       Patient[]    @relation("CaregiverPatients")
  patientProfile Patient?     @relation("UserPatientProfile")
}

model Patient {
  id                Int        @id @default(autoincrement())
  name              String
  email             String?    @unique
  age               Int?
  gender            String?
  condition         String?    @default("")
  caregiverId       Int?
  linkCode          String?    @unique
  userId            Int?       @unique
  emergencyPhone    String?
  robotSerialNumber String?
  medicines         Medicine[]
  caregiver         User?      @relation("CaregiverPatients", fields: [caregiverId], references: [id])
  user              User?      @relation("UserPatientProfile", fields: [userId], references: [id])

  @@index([caregiverId]) // âš¡ Optimized for list patients
}

model Medicine {
  id               Int               @id @default(autoincrement())
  name             String
  dosage           String
  stock            Int?              @default(0)
  qrData           Json?
  time             String?
  days             String[]
  label            String?
  slot             Int?
  icon             String?           @default("pill")
  instructions     String?           @default("")
  category         String?           @default("General")
  stockAlert       Int?              @default(5)
  imageUrls        String[]          @default([])
  patientId        Int?
  caregiverId      Int?
  createdAt        DateTime          @default(now())
  dispensationLogs DispensationLog[]
  caregiver        User?             @relation(fields: [caregiverId], references: [id])
  patient          Patient?          @relation(fields: [patientId], references: [id])
  reminders        Reminder[]

  @@index([patientId]) // âš¡ Optimized for list medicines
}

model Reminder {
  id         Int      @id @default(autoincrement())
  time       String
  days       String
  label      String?
  repeat     Boolean  @default(true)
  active     Boolean  @default(true)
  medicineId Int
  createdAt  DateTime @default(now())
  medicine   Medicine @relation(fields: [medicineId], references: [id])
}

model RobotState {
  id             Int      @id @default(autoincrement())
  status         String
  wifi           Boolean  @default(false)
  batteryPct     Int      @default(0)
  temperature    Float?   @default(0)
  uptime         String?  @default("")
  signalStrength Int?     @default(0)
  updatedAt      DateTime @default(now())
  serialNumber   String   @default("PB-001")

  @@index([serialNumber, updatedAt]) // âš¡ Optimized for getLatestStatus
}

model Invitation {
  id           Int      @id @default(autoincrement())
  token        String   @unique
  caregiverId  Int
  patientEmail String?
  patientName  String?
  used         Boolean  @default(false)
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  caregiver    User     @relation(fields: [caregiverId], references: [id])
}

model RobotLog {
  id         Int      @id @default(autoincrement())
  medicineId Int?
  message    String
  createdAt  DateTime @default(now())

  @@index([createdAt]) // âš¡ Optimized for recent logs
}

model DispensationLog {
  id          Int      @id @default(autoincrement())
  medicineId  Int
  patientId   Int?
  status      String
  mood        String?
  dispensedAt DateTime @default(now())
  medicine    Medicine @relation(fields: [medicineId], references: [id])

  @@index([patientId, dispensedAt]) // âš¡ Optimized for monitoring lookups
  @@index([medicineId])
}

model DispensationTask {
  id           Int      @id @default(autoincrement())
  serialNumber String
  slot         Int
  medicineId   Int?     // ðŸ‘ˆ Nuevo: Saber quÃ© medicina es
  patientId    Int?     // ðŸ‘ˆ Nuevo: Saber de quiÃ©n es
  status       String   @default("PENDING")
  createdAt    DateTime @default(now())

  @@index([serialNumber, status])
  @@index([medicineId, status, createdAt]) // âš¡ Optimized for monitoring match
}

model RobotInventory {
  id           Int      @id @default(autoincrement())
  serialNumber String   @default("esp32pastibot")
  slot         Int
  medicineName String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([serialNumber, slot])
}

model PasswordReset {
  id        Int      @id @default(autoincrement())
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

enum Role {
  CUIDADOR
  PACIENTE
}
